<!DOCTYPE html>
<html lang="en">
<head>
          <title>bharadwaj.machiraju</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8" />
        <link href="https://tunnelshade.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="bharadwaj.machiraju Full Atom Feed" />


    <meta name="tags" content="fuzzing" />
    <meta name="tags" content="reversing" />


        <!-- CSS -->
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css" integrity="sha384-b92sF+wDNTHrfEtRaYo+EpcA8FUyHOSXrdxKc9XB9kaaX1rSQAgMevW6cYeE5Bdv" crossorigin="anonymous">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://tunnelshade.in/theme/css/main.css">
        <!-- End CSS -->
  <link rel="stylesheet" href="https://tunnelshade.in/theme/css/blog.css">

        <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-40078808-2', 'tunnelshade.in');
  ga('send', 'pageview');
</script></head>

<body id="index" class="home">
  <br>
  <div class="pure-g">
    <div class="pure-u-2-24"></div>
    <div class="pure-u-20-24">
      <div class="pure-g">
        <div class="pure-u-md-20-24 pure-u-lg-20-24 pure-u-sm-24-24" style="display: flex; align-items: center;">
            <h1>
              <a href="https://tunnelshade.in/">bharadwaj.machiraju </a>   &raquo; <a href="https://tunnelshade.in/blog/index.html">Blog</a> <a href="https://tunnelshade.in/feeds/all.atom.xml"><i class="fa fa-rss"></i></a>
            </h1>
        </div>
        <div class="pure-u-md-4-24 pure-u-lg-4-24 pure-u-sm-0-24" style="display: flex; align-items: center;">
          <img class="logo" src="https://tunnelshade.in/theme/images/logo.png"/>
        </div>
      </div>
      <br>
      <hr>
      <br>
      <div class="pure-g">
  <div class="pure-g">
    <div class="pure-u-1 pure-u-md-4-5 pure-u-lg-4-5 pure-u-xl-4-5">
<section id="content" class="body">
  <header class="pure-g"><div class="pure-u-1">
    <h2 class="entry-title">
      <a href="https://tunnelshade.in/blog/2018/09/hongfuzz-intel-pt-instrumentation/" rel="bookmark"
         title="Permalink to Internals of Hongfuzz - Intel PT">Internals of Hongfuzz - Intel PT</a></h2>
  </div></header>
  <footer class="pure-g"><div class="pure-u-1">

    <time class="published" datetime="2018-09-05T00:00:00+05:30">
      [05-09-18]
    </time>

    [<a href="/category/tools/">Tools</a>]

    [fuzzing,reversing]

  </div></footer><!-- /.post-info -->
  <div class="pure-g"><div class="pure-u-1">
    <div class="section" id="tldr">
<h2>TLDR</h2>
<p>Intel Processor Trace is a hardware level execution tracing utility provided by Intel. The information provided is highly compressed allowing
passing of granular information. So, instead of using QEMU for coverage guided blackbox fuzzing, Intel-PT should provide a rather performant
way.</p>
</div>
<div class="section" id="recap">
<h2>Recap</h2>
<p>Before proceeding further, it is recommended to read through <a class="reference external" href="https://tunnelshade.in/blog/2018/01/afl-internals-compile-time-instrumentation/">afl compile time instrumentation</a>
to understand coverage guided fuzzing and then <a class="reference external" href="https://tunnelshade.in/blog/2018/02/afl-internals-qemu-instrumentation/">afl qemu instrumentation</a> to get hold of how QEMU
can be used to trace basic block execution.</p>
</div>
<div class="section" id="intel-pt">
<h2>1. Intel PT</h2>
<p><a class="reference external" href="https://software.intel.com/en-us/blogs/2013/09/18/processor-tracing">Intel Processor Trace</a> was introduced starting with 5th gen Intel core processors.
Linux included this in <a class="reference external" href="https://raw.githubusercontent.com/torvalds/linux/master/tools/perf/Documentation/intel-pt.txt">perf tool kit</a> as a <em>Performance Monitor Unit</em>.
The beauty of this is that we can use perf toolkit to trace execution flow of applications.</p>
</div>
<div class="section" id="fuzzing-use-case">
<h2>2. Fuzzing Use Case</h2>
<p>Coverage based fuzzing depends on what basic blocks of a program are reached in a fuzzing run. This allows fuzzer to pick subsequent inputs to force
more exploration of previously unseen code paths. First, we will look at how to record an execution trace in userland and then have a look at hongfuzz's
implementation.</p>
<p>Let us take the following simple c code and compile without <a class="reference external" href="https://en.wikipedia.org/wiki/Position-independent_code#Position-independent_executables">PIE</a>
using gcc's <strong>-no-pie</strong> flag.</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Above code will produce the following basic blocks in main function.</p>
<div class="highlight"><pre><span></span>          .--------------------------------------.
          | (fcn) main 31                        |
          |   main (signed int arg1, int arg2);  |
          | ; var int local_10h @ rbp-0x10       |
          | ; var signed int local_4h @ rbp-0x4  |
          | ; DATA XREF from entry0 (+0x21)      |
          | push rbp                             |
          | mov rbp, rsp                         |
          | ; arg1                               |
          | mov dword [local_4h], edi            |
          | ; arg2                               |
          | mov qword [local_10h], rsi           |
          | ; [0x1:4]=-1                         |
          | ; 1                                  |
          | cmp dword [local_4h], 1              |
          | jle 0x40111e;[ga]                    |
          `--------------------------------------&#39;
                  f t
                  | |
                  | &#39;-------------.
    .-------------&#39;               |
    |                             |
.-------------------------.   .----------------------------------.
|  0x401117 [gd]          |   |  0x40111e [ga]                   |
| ; -1                    |   | ; CODE XREF from main (0x401115) |
| mov eax, 0xffffffff     |   | mov eax, 0                       |
| jmp 0x401123;[gc]       |   `----------------------------------&#39;
`-------------------------&#39;       v
    v                             |
    |                             |
    &#39;-------------.               |
                  | .-------------&#39;
                  | |
            .----------------------------------.
            |  0x401123 [gc]                   |
            | ; CODE XREF from main (0x40111c) |
            | pop rbp                          |
            | ret                              |
            `----------------------------------`
</pre></div>
<p>Basic blocks at <em>0x401117</em> and <em>0x40111e</em> are the variable ones here, i.e depending on input program will choose one of these
at runtime.</p>
<div class="section" id="perf-record">
<h3>2.1 perf record</h3>
<p>Let us trace execution flow of the program once without any parameters and once with parameters and record with <a class="reference external" href="https://linux.die.net/man/1/perf-record">perf record</a>.
perf record by default stores the trace data in perf.data and all other perf tools by default read from this file in working directory.</p>
<div class="highlight"><pre><span></span>$ perf record -e intel_pt//u -- ./a.out
<span class="o">[</span> perf record: Woken up <span class="m">1</span> <span class="nb">times</span> to write data <span class="o">]</span>
<span class="o">[</span> perf record: Captured and wrote <span class="m">0</span>.010 MB perf.data <span class="o">]</span>

<span class="c1"># Let us see the basic blocks taken during this execution</span>
$ perf script --itrace<span class="o">=</span>b <span class="p">|</span> awk <span class="s2">&quot;/ main.* main/&quot;</span>

           a.out <span class="m">24665</span> <span class="o">[</span><span class="m">000</span><span class="o">]</span> <span class="m">50879</span>.554567:          <span class="m">1</span>  branches:u:            <span class="m">401115</span> main+0xf <span class="o">(</span>a.out<span class="o">)</span> <span class="o">=</span>&gt;           40111e main+0x18 <span class="o">(</span>a.out<span class="o">)</span>
</pre></div>
<p>In the above case you can see that execution went through basic block <em>0x40111e</em>. <em>-e</em> in perf record is to specify the kind of event, here we specified <em>intel_pt</em>
and <em>u</em> stands for userspace. Have a look at linux intel-pt docs for more configuration options. Let us rerun with parameters this time.</p>
<div class="highlight"><pre><span></span>$ perf record -e intel_pt//u -- ./a.out parameter
<span class="o">[</span> perf record: Woken up <span class="m">1</span> <span class="nb">times</span> to write data <span class="o">]</span>
<span class="o">[</span> perf record: Captured and wrote <span class="m">0</span>.010 MB perf.data <span class="o">]</span>

<span class="c1"># Let us see the basic blocks taken during this execution</span>
$ perf script --itrace<span class="o">=</span>b <span class="p">|</span> awk <span class="s2">&quot;/ main.* main/&quot;</span>

           a.out <span class="m">26225</span> <span class="o">[</span><span class="m">001</span><span class="o">]</span> <span class="m">51458</span>.418505:          <span class="m">1</span>  branches:u:            40111c main+0x16 <span class="o">(</span>a.out<span class="o">)</span> <span class="o">=</span>&gt;           <span class="m">401123</span> main+0x1d <span class="o">(</span>a.out<span class="o">)</span>
</pre></div>
<p>Here since the first jump didn't happen, we only see the second jump i.e from basic block starting at <em>0x40111c</em> to <em>0x401123</em>. This is more passive way of analyzing
already stored trace of an execution.</p>
</div>
<div class="section" id="perf-event-open">
<h3>2.2 perf_event_open</h3>
<p><a class="reference external" href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html">perf_event_open</a> is the programmatic way of doing the same. That man page does better
job of explaining than I ever can.</p>
</div>
<div class="section" id="hongfuzz">
<h3>2.3 Hongfuzz</h3>
<ul class="simple">
<li>Hongfuzz <a class="reference external" href="https://github.com/google/honggfuzz/blob/cc6b929d45b8bbfb3e28617ab511a2b23b5aa962/linux/perf.c#L116">uses</a> this api to leverage basic block tracing.</li>
<li>Then it mmaps this filedescriptor to enable reading sampled events from the ring buffer in userspace.</li>
<li>Subsequently it leverages Intel's <a class="reference external" href="https://github.com/01org/processor-trace/blob/master/doc/howto_libipt.md">libipt</a> to decode these event packets.</li>
<li><a class="reference external" href="https://github.com/google/honggfuzz/blob/cc6b929d45b8bbfb3e28617ab511a2b23b5aa962/linux/pt.c#L47">Updates</a> it's feedback map based on the events.</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">hot</span><span class="p">))</span> <span class="kr">inline</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">perf_ptAnalyzePkt</span><span class="p">(</span><span class="n">run_t</span><span class="o">*</span> <span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_packet</span><span class="o">*</span> <span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ppt_tip</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">uint64_t</span> <span class="n">ip</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ipc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">pt_ipc_update_16</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">pt_ipc_update_32</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">pt_ipc_update_48</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFF</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">pt_ipc_sext_48</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">pt_ipc_full</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ip</span> <span class="o">&amp;=</span> <span class="n">_HF_PERF_BITMAP_BITSZ_MASK</span><span class="p">;</span>
    <span class="k">register</span> <span class="kt">uint8_t</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ATOMIC_BTS</span><span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">feedback</span><span class="p">.</span><span class="n">feedbackMap</span><span class="o">-&gt;</span><span class="n">bbMapPc</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">run</span><span class="o">-&gt;</span><span class="n">linux</span><span class="p">.</span><span class="n">hwCnts</span><span class="p">.</span><span class="n">newBBCnt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Leveraging hardware tracing features like these will enable blackbox coverage guided fuzzing to be a lot faster than usermode translation hooks
like that were done in AFL QEMU's case. There also exists a <a class="reference external" href="https://github.com/hunter-ht-2018/ptfuzzer">AFL fork</a> leveraing Intel PT .</p>
</div>
</div>

  </div></div><!-- /.entry-content -->
</section>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://tunnelshade.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>    </div>
    <div class="pure-u-1 pure-u-md-1-5 pure-u-lg-1-5 pure-u-xl-1-5 blog_sidebar">
      <strong>Categories</strong>
      <ul>
          <li><a href="/category/bugs/">Bugs</a> [6]</li>
          <li><a href="/category/hacks/">Hacks</a> [2]</li>
          <li><a href="/category/information/">Information</a> [5]</li>
          <li><a href="/category/linux/">Linux</a> [7]</li>
          <li><a href="/category/python/">Python</a> [4]</li>
          <li><a href="/category/tools/">Tools</a> [12]</li>
      </ul>

      <br>

      <strong>Tags</strong>
      <ul>
          <li><a href="/tag/reversing/">reversing</a> [5]</li>
          <li><a href="/tag/tools/">tools</a> [11]</li>
          <li><a href="/tag/fuzzing/">fuzzing</a> [3]</li>
          <li><a href="/tag/afl/">afl</a> [2]</li>
          <li><a href="/tag/tricks/">tricks</a> [11]</li>
          <li><a href="/tag/info/">info</a> [12]</li>
          <li><a href="/tag/python/">python</a> [3]</li>
          <li><a href="/tag/hacks/">hacks</a> [5]</li>
          <li><a href="/tag/conference/">conference</a> [2]</li>
          <li><a href="/tag/linux/">linux</a> [5]</li>
          <li><a href="/tag/owtf/">owtf</a> [3]</li>
          <li><a href="/tag/screenshots/">screenshots</a> [3]</li>
      </ul>

      <br>

      <strong>Author</strong>
<ul class="no_bullets">
    <li><a class="no_underline" href="https://twitter.com/tunnelshade_"><i class="fa fa-twitter"></i> @tunnelshade_</a></li>
    <li><a class="no_underline" href="https://github.com/tunnelshade"><i class="fa fa-github"></i> Github</a></li>
    <li><a class="no_underline" href="https://in.linkedin.com/pub/bharadwaj-machiraju/45/109/38/"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
    <li><a class="no_underline" href="domain_without_tld@gmail.com"><i class="fa fa-envelope"></i> domain_without_tld@gmail.com</a></li>
</ul>
    </div>
  </div>
      </div>
    </div>
    <div class="pure-u-2-24"></div>
  </div>
</body>
</html>